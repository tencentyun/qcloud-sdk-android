# Nginx 反向代理配置
# 用于测试 COS 自定义域名的自签名证书和双向认证场景
#
# 使用方法:
# 1. 先生成证书: bash scripts/generate-certs.sh
# 2. 将此配置复制到 nginx 配置目录或 include 进去
# 3. 修改下面的 COS bucket 和 region 信息
# 4. 重启 nginx: nginx -s reload

# ============================================================
# 场景1: 自签名证书 - 单向 SSL
# 端口: 8443
# 测试: curl --cacert certs/ca.crt https://localhost:8443/
# ============================================================
server {
    listen 8443 ssl;
    server_name localhost;

    # 服务端证书（自签名）
    ssl_certificate     /path/to/ssl-test-server/certs/server.crt;
    ssl_certificate_key /path/to/ssl-test-server/certs/server.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # 访问日志
    access_log /var/log/nginx/cos-proxy-simple.log;
    error_log  /var/log/nginx/cos-proxy-simple-error.log;

    # ========== 修改这里的 bucket 和 region ==========
    set $cos_bucket "mobile-ut-1253960454";  # 替换为你的 bucket
    set $cos_region "ap-guangzhou";              # 替换为你的 region
    # ================================================

    location / {
        # 转发到真实的 COS 服务器
        proxy_pass https://$cos_bucket.cos.$cos_region.myqcloud.com;
        
        # 设置 Host 头为 COS 域名
        proxy_set_header Host $cos_bucket.cos.$cos_region.myqcloud.com;
        
        # 保留原始请求信息
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 透传所有请求头（包括 Authorization）
        proxy_pass_request_headers on;
        
        # 支持大文件上传
        client_max_body_size 5G;
        proxy_request_buffering off;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # SSL 连接到后端 COS
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
    }
}

# ============================================================
# 场景2: 双向认证 (mTLS)
# 端口: 8444
# 测试: curl --cacert certs/ca.crt --cert certs/client.crt --key certs/client.key https://localhost:8444/
# ============================================================
server {
    listen 8444 ssl;
    server_name localhost;

    # 服务端证书
    ssl_certificate     /path/to/ssl-test-server/certs/server.crt;
    ssl_certificate_key /path/to/ssl-test-server/certs/server.key;

    # 客户端证书验证（双向认证）
    ssl_client_certificate /path/to/ssl-test-server/certs/ca.crt;
    ssl_verify_client on;  # 强制要求客户端证书

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # 访问日志
    access_log /var/log/nginx/cos-proxy-mtls.log;
    error_log  /var/log/nginx/cos-proxy-mtls-error.log;

    # ========== 修改这里的 bucket 和 region ==========
    set $cos_bucket "mobile-ut-1253960454";  # 替换为你的 bucket
    set $cos_region "ap-guangzhou";              # 替换为你的 region
    # ================================================

    location / {
        # 转发到真实的 COS 服务器
        proxy_pass https://$cos_bucket.cos.$cos_region.myqcloud.com;
        
        # 设置 Host 头为 COS 域名
        proxy_set_header Host $cos_bucket.cos.$cos_region.myqcloud.com;
        
        # 保留原始请求信息
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 添加客户端证书信息到请求头（可选，用于调试）
        proxy_set_header X-SSL-Client-CN $ssl_client_s_dn;
        proxy_set_header X-SSL-Client-Verify $ssl_client_verify;
        
        # 透传所有请求头
        proxy_pass_request_headers on;
        
        # 支持大文件上传
        client_max_body_size 5G;
        proxy_request_buffering off;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # SSL 连接到后端 COS
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
    }
}
